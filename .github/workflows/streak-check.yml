name: GitHub Streak Reminder

on:
  schedule:
    - cron: '0 12 * * *' # 毎日 UTC 12:00 = JST 21:00
  workflow_dispatch: # 手動実行用

jobs:
  check-contribution:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check GitHub contribution and notify
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            あなたは GitHub の草チェック Bot です。以下のタスクを実行してください。

            ## タスク
            1. GitHub GraphQL API を使用して、ユーザー `axelaspor2` の今日のコントリビューション数を取得
            2. コントリビューション数に応じて Discord Webhook に通知を送信

            ## 実行手順

            ### Step 1: 今日の日付を取得（JST 基準）
            ```bash
            TZ=Asia/Tokyo date +%Y-%m-%d
            ```

            ### Step 2: GitHub GraphQL API でコントリビューションを取得
            ```bash
            gh api graphql -f query='
            query {
              user(login: "axelaspor2") {
                contributionsCollection {
                  contributionCalendar {
                    weeks {
                      contributionDays {
                        contributionCount
                        date
                      }
                    }
                  }
                }
              }
            }'
            ```

            取得したデータから今日の日付に該当する `contributionCount` を確認してください。

            ### Step 3: Discord 通知
            コントリビューション数に応じて、以下の curl コマンドで Discord に通知を送信してください。
            メッセージ内容はあなたの気まぐれで自由に考えてください！

            - 草がなかった場合: 励ましや煽りのメッセージ
            - 草があった場合: 褒めたり、称賛したり、ユーモアのあるコメント

            ```bash
            curl -H "Content-Type: application/json" \
                 -d '{"content": "ここに自由なメッセージを入れてください"}' \
                 "$DISCORD_WEBHOOK_URL"
            ```

            ### Step 4: 結果報告
            送信したメッセージの内容を報告してください
          claude_args: '--max-turns 10'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
